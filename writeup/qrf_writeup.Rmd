---
title: "Estimates of Carrying Capacity with Quantile Random Forest Models"
author:
  - name: Kevin See
    affiliation: biomark
    email: kevin.see@merck.com
  - name: Mike Ackerman
    affiliation: Biomark, Inc.
    email: mike.ackerman@merck.com
  - name: Richie Carmichael
    affiliation: Biomark, Inc.
    email: richard.carmichael@merck.com
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  bookdown::html_document2:
    theme: simplex
    toc: yes
    toc_depth: 3
    toc_float: yes
    fig_height: 6
    fig_width: 8
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
  bookdown::pdf_document2:
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks2.lua
    - --lua-filter=../templates/pagebreak.lua
    fig_height: 6
    fig_width: 8
    includes:
      in_header: "../templates/header_ABS.tex"
  bookdown::word_document2: 
    fig_caption: yes
    fig_height: 4
    fig_width: 7
    toc: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
    reference_docx: "../templates/ReportTemplate.docx"
institute:
- biomark: Biomark, Inc.
csl: "../templates/american-fisheries-society.csl"
# bibliography: references.bib
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# setwd('writeup')
# load knitr for markdown
library(knitr)
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE,
                      fig.path = "../output/figures/")
#options(tinytex.verbose = TRUE)
options(knitr.kable.NA = '-')
options(knitr.table.format = "pandoc")

library(kableExtra)
```

```{r}
# load needed packages
library(tidyverse)
library(sf)
library(QRFcapacity)
library(janitor)
library(ggpubr)

theme_set(theme_bw())
```

```{r load-data}
# QRF model fits and associated data
load('../data/qrf/qrf_juv_summer_dash.rda')

# DASH data from 2018
load('../data/dash/dash2018_fr.rda')

# geomorphic polygons
lem_geo_rch = st_read('../data/geo_reaches/Lem_Poly_Label.shp',
                      quiet = T) %>%
  mutate(GeoReach = factor(Name,
                           levels = paste0("GR_", 1:nlevels(Name)))) %>%
  select(-Name)

pah_geo_rch = st_read('../data/geo_reaches/Pah_Poly_Label.shp',
                      quiet = T) %>%
  mutate(GeoReach = factor(GeoReach,
                           levels = paste0("GR-", 8:10)))

ups_geo_rch = st_read('../data/geo_reaches/US_Poly_Label.shp',
                      quiet = T) %>%
  mutate(GeoReach = factor(GeoReach,
                           levels = paste0("GR-", 4:10)))

# QRF extrapolations in Salmon subbasin on 200 m reaches
salm_cap = st_read('../data/qrf/salmon_cap.gpkg',
                   quiet = T) %>%
  st_transform(st_crs(lem_geo_rch))

```

```{r cap-pred-mra-rchs} 
pred_sf = dash2018_fr %>%
  ungroup() %>%
  rename(avg_aug_temp = S2_02_11,
         LWVol_Wet = Wod_Vlm,
         Q = MeanU_v1,
         Sin_CL = sin,
         SlowWater_Pct = Slowwat_Pct,
         SubEstGrvl = Prc_Grv,
         WetBraid = wet_braid,
         WetSC_Pct = SC_Pct,
         Lgth_Wet = Length,
         Area_Wet = SHAPE_A) %>%
  mutate(FishCovSome = 100 - FishCovNone,
         UcutLgth_Pct = Undrc_L / Lgth_Wet,
         WetWdth_Int = Area_Wet / Lgth_Wet) %>%
  mutate_at(vars(SlowWater_Pct, WetSC_Pct, Hab_Roll),
            list(~ if_else(is.na(.), 0, .))) %>%
  select(Site = SiteNam,
         Hab_Roll,
         Lgth_Wet,
         Area_Wet,
         one_of(unique(sel_hab_mets$Metric))) %>%
  filter(!is.na(Hab_Roll)) %>%
  filter(!is.na(Sin_CL))

pred_df = pred_sf %>%
  st_drop_geometry() %>%
  as_tibble()

# what quantile is a proxy for capacity?
pred_quant = 0.9

# make predictions at every hab_roll reach
pred_df %<>%
  mutate(chnk_per_m = predict(qrf_mods[['Chinook']],
                              newdata = select(., one_of(unique(sel_hab_mets$Metric))),
                              what = pred_quant),
         chnk_per_m = exp(chnk_per_m) - dens_offset,
         chnk_per_m2 = chnk_per_m * Lgth_Wet / Area_Wet)

pred_sf %<>%
  left_join(pred_df %>%
              select(Site, Hab_Roll,
                     starts_with('chnk_per')))

save(pred_sf,
     file = "../data/qrf/mra_preds.rda")
```


# Introduction

## QRF Model

We developed a quantile random forest (QRF) model with paired fish and habitat data from a number of sites around the Columbia River Basin (Table \@ref(tab:sample-size)). We developed separate QRF models for each species, using the haitat covariates shown in Table \@ref(tab:sel-mets).

```{r sample-size}
qrf_mod_df %>%
  tabyl(Watershed, Species) %>%
  adorn_totals() %>%
  kable(boottabs = T,
        caption = 'Number of sites with fish/habtiat data that went into QRF model.') %>%
  kable_styling()
```

```{r sel-mets}
sel_hab_mets %>%
  select(Metric) %>%
  distinct() %>%
  left_join(hab_dict %>%
              select(Metric = ShortName,
                     Name,
                     MetricCategory,
                     DescriptiveText)) %>%
  arrange(MetricCategory,
          Metric) %>%
  kable(booktabs = T,
        caption = 'Selected habitat covariates for QRF model.') %>%
  kable_styling()
```

The relative importance of the habitat covariates are shown in Figure \@ref(fig:rel-imp). 

```{r rel-imp, fig.cap="Relative importance of each habitat covariate, colored by species."}
# relative importance of habtiat covariates
qrf_mods %>%
  map_df(.id = 'Species',
         .f = function(x) {
           as_tibble(x$importance,
                     rownames = 'Metric') %>%
             mutate(relImp = IncNodePurity / max(IncNodePurity)) 
         }) %>%
  left_join(hab_dict %>%
              select(Metric = ShortName,
                     Name)) %>%
  mutate_at(vars(Metric, Name),
            list(~ fct_reorder(., relImp))) %>%
  arrange(Metric) %>%
  ggplot(aes(x = Name,
             y = relImp)) +
  geom_col(aes(fill = Species),
           position = 'dodge') +
  scale_fill_brewer(palette = "Set1") +
  coord_flip() +
  theme(legend.position = "bottom") +
  labs(x = 'Metric',
       y = 'Relative Importance')
```

```{r rel-imp-v2, eval = F, fig.cap="Relative importance of each habitat covariate, by species."}
# separate plots by species
rel_imp_list = qrf_mods %>%
  map(.f = function(x) {
    as_tibble(x$importance,
              rownames = 'Metric') %>%
      mutate(relImp = IncNodePurity / max(IncNodePurity)) %>%
      left_join(hab_dict %>%
                  select(Metric = ShortName,
                         Name)) %>%
      mutate_at(vars(Metric, Name),
                list(~ fct_reorder(., relImp))) %>%
      arrange(Metric) %>%
      distinct() %>%
      ggplot(aes(x = Name,
                 y = relImp)) +
      geom_col(fill = 'gray40') +
      coord_flip() +
      labs(x = 'Metric',
           y = 'Relative Importance')
    
  })
# add species name to each plot
for(i in 1:length(rel_imp_list)) {
  rel_imp_list[[i]] = rel_imp_list[[i]] +
    labs(title = names(qrf_mods)[[i]])
}

all_rel_imp_p = ggpubr::ggarrange(plotlist = rel_imp_list,
                  nrow = 1,
                  ncol = 2)
all_rel_imp_p
```

Partial dependence plots show the marginal effect of each covariate by displaying the predicted capacity as that covariate changes, assuming all the other covariates remain fixed at their average values. The partial dependence plots are shown for Chinook (Figure \@ref(fig:pdp-chnk)) and steelhead (Figure \@ref(fig:pdp-sthd)).

```{r pdp-chnk, fig.cap = "Partial dependence plots for Chinook QRF model."}
plot_partial_dependence(qrf_mods[['Chinook']],
                        qrf_mod_df %>%
                          filter(Species == 'Chinook'),
                        data_dict = hab_dict,
                        log_offset = dens_offset,
                        scales = 'free') +
  labs(title = 'Chinook')
```

```{r pdp-sthd, fig.cap = "Partial dependence plots for steelhead QRF model."}
plot_partial_dependence(qrf_mods[['Steelhead']],
                        qrf_mod_df %>%
                          filter(Species == 'Steelhead'),
                        data_dict = hab_dict,
                        log_offset = dens_offset,
                        scales = 'free') +
  labs(title = 'Steelhead')
```

From this QRF model, we made capacity predictions at every CHaMP site, after averaging the habitat metrics across years for sites visited more than once. We then tied each CHaMP site to a 200 m reach on a stream network with various attributes, and used those attributes to extrapolate capacity to every 200 m reach on that network.

# Methods

## Geomorphic Reaches

We took our QRF extrapolation estimates at each 200 m reach, and determined which reaches fell into each geomorphic reach within each watershed. Then we examined the distribution of capacity estimates within each reach, and the average capacity for each reach.

## Capacity at MRA sites

We used the QRF model to predict capacity at MRA sites that were sampled with DASH in 2018. We used the predicted `r pred_quant * 100`th quantile as a proxy for carrying capacity. 

# Results

## Geomorphic Reaches

The distribution of capacity predictions within each geomorphic reach is shown in Figures \@ref(fig:chnk-violin-p) and \@ref(fig:sthd-violin-p). Figures \@ref(fig:lem-map), \@ref(fig:pah-map) and \@ref(fig:ups-map) are maps depicting the average capacity within each geomorphic reach.

```{r}
geo_rch_list = list("Lemhi" = lem_geo_rch %>%
                      mutate(Watershed = 'Lemhi'),
                    "Pahsimeroi" = pah_geo_rch %>%
                      mutate(Watershed = 'Pahsimeroi'),
                    "Upper Salmon" = ups_geo_rch %>%
                      mutate(Watershed = 'Upper Salmon'))

gr_cap = geo_rch_list %>%
  map(.f = function(x) {
    x %>%
      st_join(salm_cap %>%
            filter(sthd) %>%
            select(UniqueID, 
                   GNIS_Name,
                   model,
                   matches('sthd_per'), 
                   matches('sthd_tot')) %>%
            full_join(salm_cap %>%
                        filter(chnk) %>%
                        st_drop_geometry() %>%
                        select(UniqueID, 
                               GNIS_Name,
                               model,
                               matches('chnk_per'), 
                               matches('chnk_tot')))) %>%
      filter((Watershed == 'Lemhi' & GNIS_Name == 'Lemhi River') |
               (Watershed == 'Pahsimeroi' & GNIS_Name == 'Pahsimeroi River') |
               (Watershed == 'Upper Salmon' & GNIS_Name == 'Salmon River')) %>%
      mutate(rch_num = str_extract(GeoReach, '[:digit:]+'),
             rch_num = as.numeric(rch_num),
             GeoReach = str_replace(GeoReach, '_', '-')) %>%
      mutate(GeoReach = factor(GeoReach,
                           levels = paste0("GR-", min(rch_num):max(rch_num))))
  })

# put into data.frame
gr_cap_df = gr_cap %>%
  map_df(.id = NULL,
         .f = function(x) {
           x %>%
             st_drop_geometry() %>%
             as_tibble()
         }) %>%
  mutate(GeoReach = factor(GeoReach,
                           levels = paste0("GR-", min(rch_num):max(rch_num))))

```

```{r chnk-violin-p, fig.cap = "Violin plots showing the distribution of Chinook capacity estimates for 200 m reaches within each geomorphic reach in each watershed."}
gr_cap_df %>%
  ggplot(aes(x = GeoReach,
             y = chnk_per_m)) +
  # geom_boxplot(fill = 'lightblue') +
  geom_violin(fill = 'lightblue',
              scale = 'width',
              draw_quantiles = c(0.25, 0.5, 0.75)) +
  facet_wrap(~ Watershed,
             scales = 'free_x',
             nrow = 1) +
  labs(x = 'Geomorphic Reach',
       y = 'Chinook capacity (per m)') +
  theme(axis.text.x = element_text(angle = -45, vjust = 0))

```

```{r sthd-violin-p, fig.cap = "Violin plots showing the distribution of steelhead capacity estimates for 200 m reaches within each geomorphic reach in each watershed."}
gr_cap_df %>%
  ggplot(aes(x = GeoReach,
             y = sthd_per_m)) +
  # geom_boxplot(fill = 'lightblue') +
  geom_violin(fill = 'lightblue',
              scale = 'width',
              draw_quantiles = c(0.25, 0.5, 0.75)) +
  facet_wrap(~ Watershed,
             scales = 'free_x',
             nrow = 1) +
  labs(x = 'Geomorphic Reach',
       y = 'Steelhead capacity (per m)') +
  theme(axis.text.x = element_text(angle = -45, vjust = 0))

```


```{r lem-map, fig.cap = "Geomorphic reaches in the Lemhi colored by average capacity (fish per m). Note different scales for each species."}
lem_chnk_map = gr_cap$Lemhi %>%
  group_by(GeoReach) %>%
  summarise_at(vars(matches('per_m')),
               list(mean),
               na.rm = T) %>%
  ungroup() %>%
  ggplot() +
  geom_sf(aes(fill = chnk_per_m)) +
  scale_fill_viridis_c(direction = -1,
                       name = 'Capacity per m') +
  geom_sf_label(aes(label = str_remove(GeoReach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  labs(title = 'Chinook')

lem_sthd_map = gr_cap$Lemhi %>%
  group_by(GeoReach) %>%
  summarise_at(vars(matches('per_m')),
               list(mean),
               na.rm = T) %>%
  ungroup() %>%
  ggplot() +
  geom_sf(aes(fill = sthd_per_m)) +
  scale_fill_viridis_c(direction = -1,
                       name = 'Capacity per m') +
  geom_sf_label(aes(label = str_remove(GeoReach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  labs(title = 'Steelhead')

ggarrange(plotlist = list(lem_chnk_map,
                          lem_sthd_map),
          labels = 'AUTO',
          nrow = 1)

```

```{r pah-map, fig.cap = "Geomorphic reaches in the Pahsimeroi colored by average capacity (fish per m). Note different scales for each species."}
pah_chnk_map = gr_cap$Pahsimeroi %>%
  group_by(GeoReach) %>%
  summarise_at(vars(matches('per_m')),
               list(mean),
               na.rm = T) %>%
  ungroup() %>%
  ggplot() +
  geom_sf(aes(fill = chnk_per_m)) +
  scale_fill_viridis_c(direction = -1,
                       name = 'Capacity per m') +
  geom_sf_label(aes(label = str_remove(GeoReach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  labs(title = 'Chinook')

pah_sthd_map = gr_cap$Pahsimeroi %>%
  group_by(GeoReach) %>%
  summarise_at(vars(matches('per_m')),
               list(mean),
               na.rm = T) %>%
  ungroup() %>%
  ggplot() +
  geom_sf(aes(fill = sthd_per_m)) +
  scale_fill_viridis_c(direction = -1,
                       name = 'Capacity per m') +
  geom_sf_label(aes(label = str_remove(GeoReach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  labs(title = 'Steelhead')

ggarrange(plotlist = list(pah_chnk_map,
                          pah_sthd_map),
          labels = 'AUTO',
          nrow = 1)

```

```{r ups-map, fig.cap = "Geomorphic reaches in the upper Salmon colored by average capacity (fish per m). Note different scales for each species."}
ups_chnk_map = gr_cap$`Upper Salmon` %>%
  group_by(GeoReach) %>%
  summarise_at(vars(matches('per_m')),
               list(mean),
               na.rm = T) %>%
  ungroup() %>%
  ggplot() +
  geom_sf(aes(fill = chnk_per_m)) +
  scale_fill_viridis_c(direction = -1,
                       name = 'Capacity per m') +
  geom_sf_label(aes(label = str_remove(GeoReach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  labs(title = 'Chinook')

ups_sthd_map = gr_cap$`Upper Salmon` %>%
  group_by(GeoReach) %>%
  summarise_at(vars(matches('per_m')),
               list(mean),
               na.rm = T) %>%
  ungroup() %>%
  ggplot() +
  geom_sf(aes(fill = sthd_per_m)) +
  scale_fill_viridis_c(direction = -1,
                       name = 'Capacity per m') +
  geom_sf_label(aes(label = str_remove(GeoReach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  labs(title = 'Steelhead')

ggarrange(plotlist = list(ups_chnk_map,
                          ups_sthd_map),
          labels = 'AUTO',
          nrow = 1)

```

## Capacity at MRA sites

```{r mra-maps}
map_list = pred_sf %>%
  split(list(.$Site)) %>%
  map(.f = function(x) {
    x %>%
      ggplot() +
      geom_sf(aes(color = chnk_per_m2,
                  fill = chnk_per_m2)) +
      scale_color_viridis_c(direction = -1,
                            name = bquote("Chinook Parr (per " *m^2 *")")) +
      scale_fill_viridis_c(direction = -1,
                           name = bquote("Chinook Parr (per " *m^2 *")")) +
      theme(axis.text = element_blank(),
            legend.position = 'bottom') +
      labs(title = unique(x$Site))
  })

# save maps as pdfs
pdf("../output/figures/Chnk_Parr_Maps.pdf",
       width = 5,
       height = 8)
for(i in seq_along(map_list)) {
  print(map_list[[i]])
}
dev.off()

# ggarrange(plotlist = map_list,
#           nrow = 2,
#           ncol = 2,
#           common.legend = T,
#           legend = 'bottom')

```

```{r qrf-upl-map}
map_list[["UpperLemhi_2018"]]
```

```{r qrf-pah-map}
map_list[["Pahsimeroi_2018"]]
```

```{r qrf-lwl-map}
map_list[["LowerLemhi_2018"]]
```

```{r qrf-usl-map}
map_list[["UpperSalmon_2018"]]
```
