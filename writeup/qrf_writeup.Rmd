---
title: "Estimates of Carrying Capacity with Quantile Random Forest Models"
author:
  - name: Kevin See
    affiliation: biomark
    email: kevin.see@merck.com
  - name: Mike Ackerman
    affiliation: Biomark, Inc.
    email: mike.ackerman@merck.com
  - name: Richie Carmichael
    affiliation: Biomark, Inc.
    email: richard.carmichael@merck.com
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  bookdown::html_document2:
    theme: simplex
    toc: yes
    toc_depth: 3
    toc_float: yes
    fig_height: 6
    fig_width: 8
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
  bookdown::pdf_document2:
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks2.lua
    - --lua-filter=../templates/pagebreak.lua
    fig_height: 6
    fig_width: 8
    includes:
      in_header: "../templates/header_ABS.tex"
  bookdown::word_document2: 
    fig_caption: yes
    fig_height: 4
    fig_width: 7
    toc: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
    reference_docx: "../templates/ReportTemplate.docx"
institute:
- biomark: Biomark, Inc.
csl: "../templates/american-fisheries-society.csl"
# bibliography: references.bib
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# setwd('writeup')
# load knitr for markdown
library(knitr)
knitr::opts_chunk$set(echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE,
                      fig.path = "../output/figures/")
#options(tinytex.verbose = TRUE)
options(knitr.kable.NA = '-')
options(knitr.table.format = "pandoc")

library(kableExtra)
```

```{r}
# load needed packages
library(tidyverse)
library(sf)
library(QRFcapacity)
library(janitor)
library(ggpubr)
library(magrittr)
library(quantregForest)

theme_set(theme_bw())
```

```{r load-data}
# QRF model fits and associated data
load('../data/qrf/qrf_juv_summer_dash.rda')

# DASH data from 2018
load('../data/dash/dash2018_hr.rda')

# geomorphic polygons
lem_geo_rch = st_read('../data/geo_reaches/Lem_Poly_Label.shp',
                      quiet = T) %>%
  mutate(GeoReach = factor(Name,
                           levels = paste0("GR_", 1:n_distinct(Name)))) %>%
  select(-Name)

pah_geo_rch = st_read('../data/geo_reaches/Pah_Poly_Label.shp',
                      quiet = T) %>%
  mutate(GeoReach = factor(GeoReach,
                           levels = paste0("GR-", 8:10)))

ups_geo_rch = st_read('../data/geo_reaches/US_Poly_Label.shp',
                      quiet = T) %>%
  mutate(GeoReach = factor(GeoReach,
                           levels = paste0("GR-", 4:10)))

# QRF extrapolations in Salmon subbasin on 200 m reaches
# salm_cap = st_read('../data/qrf/salmon_cap.gpkg',
#                    quiet = T) %>%
#   st_transform(st_crs(lem_geo_rch))

rch_cap = st_read('../data/qrf/UpperSalmon_Rch200_Cap_juv_summer_dash.gpkg',
                  quiet = T) %>%
  st_transform(st_crs(lem_geo_rch)) %>%
  mutate(chnk_tot = chnk_per_m * reach_leng,
         chnk_tot_se = chnk_per_m_se * reach_leng,
         sthd_tot = sthd_per_m * reach_leng,
         sthd_tot_se = sthd_per_m_se * reach_leng)


# QRF extrapolations in Salmon subbasin on master sample points
cap_pts = st_read('../data/qrf/UpperSalmon_MastPts_Cap_juv_summer_dash.gpkg',
                  quiet = T) %>%
  st_transform(st_crs(lem_geo_rch))

```

```{r cap-pred-mra-rchs} 
pred_sf = dash2018_hr_gaa %>%
  ungroup() %>%
  # group_by(SiteNam, Hab_Rch) %>%
  # slice(1) %>%
  # ungroup() %>%
  rename(avg_aug_temp = S2_02_11,
         LWVol_Wet = Wod_Vlm,
         # Q = MeanU_v1,
         Sin_CL = sinuosity,
         SlowWater_Pct = Slowwater_Pct,
         SubEstGrvl = Prc_Grv,
         WetBraid = wet_braid,
         WetSC_Pct = SC_Pct,
         Lgth_Wet = Length.x,
         Area_Wet = SHAPE_A,
         FishCovSome = Tot_Cov) %>%
  mutate_at(vars(avg_aug_temp),
            list(~ as.numeric(as.character(.)))) %>%
  mutate(UcutLgth_Pct = Undrc_L / Lgth_Wet,
         WetWdth_Int = Area_Wet / Lgth_Wet,
         CU_Freq = CU_Cnt / Lgth_Wet * 100) %>%
  mutate_at(vars(SlowWater_Pct, WetSC_Pct),
            list(~ if_else(is.na(.), 0, .))) %>%
  # convert discharge from cfs to m3/s
  # mutate_at(vars(Q = MeanU_v1),
  #           list(measurements::conv_unit),
  #           from = "ft3_per_sec",
  #           to = "m3_per_sec") %>%
  select(Site = SiteNam,
         Hab_Rch,
         Lgth_Wet,
         Area_Wet,
         one_of(unique(sel_hab_mets$Metric))) %>%
  filter(!is.na(Hab_Rch)) %>%
  filter(!is.na(Sin_CL))

pred_df = pred_sf %>%
  st_drop_geometry() %>%
  as_tibble()

# what quantile is a proxy for capacity?
pred_quant = 0.9

# make predictions at every hab_roll reach
pred_df %<>%
  na.omit() %>%
  mutate(chnk_per_m = predict(qrf_mods[['Chinook']],
                              newdata = select(., one_of(unique(sel_hab_mets$Metric))),
                              what = pred_quant),
         chnk_per_m = exp(chnk_per_m) - dens_offset,
         chnk_per_m2 = chnk_per_m * Lgth_Wet / Area_Wet)

pred_sf %<>%
  left_join(pred_df %>%
              select(Site, Hab_Rch,
                     starts_with('chnk_per')))

# pred_sf %>%
#   slice(unique(which(is.na(pred_sf), T)[,1])) %>%
#   select(Site, Hab_Rch,
#          LWVol_Wet,
#          SubEstGrvl,
#          UcutLgth_Pct) %>%
#   arrange(Site, Hab_Rch)

```

```{r save-qrf-preds}
# need to split back into lines and polygons to save
# save polygons
pred_sf %>%
  group_by(Site, Hab_Rch) %>%
  nest() %>%
  mutate(cast_data = map(data,
                         .f = st_cast)) %>%
  select(-data) %>%
  unnest(cols = cast_data) %>%
  ungroup() %>%
  st_as_sf() %>%
  mutate(geom_type = st_geometry_type(.)) %>%
  filter(geom_type %in% c("POLYGON", "MULTIPOLYGON")) %>%
  select(-geom_type) %>%
  st_write("../data/qrf/mra_preds_poly.gpkg",
           append = F,
           quiet = T)

# save lines
pred_sf %>%
  group_by(Site, Hab_Rch) %>%
  nest() %>%
  mutate(cast_data = map(data,
                         .f = st_cast)) %>%
  select(-data) %>%
  unnest(cols = cast_data) %>%
  ungroup() %>%
  st_as_sf() %>%
  mutate(geom_type = st_geometry_type(.)) %>%
  filter(!geom_type %in% c("POLYGON", "MULTIPOLYGON")) %>%
  select(-geom_type) %>%
  st_write("../data/qrf/mra_preds_line.gpkg",
           append = F,
           quiet = T)
```


# Introduction

## QRF Model

We developed a quantile random forest (QRF) model with paired fish and habitat data from a number of sites around the Columbia River Basin (Table \@ref(tab:sample-size)). We developed separate QRF models for each species, using the haitat covariates shown in Table \@ref(tab:sel-mets). Please note that the total volume of large wood has been scaled by the site length, so it is in units of m$^3$ / 100 m. 

```{r sample-size}
qrf_mod_df %>%
  tabyl(Watershed, Species) %>%
  adorn_totals() %>%
  kable(boottabs = T,
        caption = 'Number of sites with fish/habtiat data that went into QRF model.') %>%
  kable_styling()
```

```{r sel-mets}
sel_hab_mets %>%
  select(Metric) %>%
  distinct() %>%
  left_join(hab_dict %>%
              select(Metric = ShortName,
                     Name,
                     MetricCategory,
                     DescriptiveText)) %>%
  arrange(MetricCategory,
          Metric) %>%
  kable(booktabs = T,
        caption = 'Selected habitat covariates for QRF model.') %>%
  kable_styling()
```

The relative importance of the habitat covariates are shown in Figure \@ref(fig:rel-imp). 

```{r rel-imp, fig.cap="Relative importance of each habitat covariate, colored by species."}
# relative importance of habtiat covariates
qrf_mods %>%
  map_df(.id = 'Species',
         .f = function(x) {
           as_tibble(x$importance,
                     rownames = 'Metric') %>%
             mutate(relImp = IncNodePurity / max(IncNodePurity)) 
         }) %>%
  left_join(hab_dict %>%
              select(Metric = ShortName,
                     Name)) %>%
  mutate_at(vars(Metric, Name),
            list(~ fct_reorder(., relImp))) %>%
  arrange(Metric) %>%
  ggplot(aes(x = Name,
             y = relImp)) +
  geom_col(aes(fill = Species),
           position = 'dodge') +
  scale_fill_brewer(palette = "Set1") +
  coord_flip() +
  theme(legend.position = "bottom") +
  labs(x = 'Metric',
       y = 'Relative Importance')
```

```{r rel-imp-v2, eval = T, fig.cap="Relative importance of each habitat covariate, by species."}
# relative importance data.frames
rel_imp_df = qrf_mods %>%
  map_df(.id = 'Species',
         .f = function(x) {
           as_tibble(x$importance,
                     rownames = 'Metric') %>%
             mutate(relImp = IncNodePurity / max(IncNodePurity)) %>%
             left_join(hab_dict %>%
                         select(Metric = ShortName,
                                Name)) %>%
             mutate_at(vars(Metric, Name),
                       list(~ fct_reorder(., relImp))) %>%
             arrange(Metric) %>%
             distinct()
         })

# separate plots by species
rel_imp_list = rel_imp_df %>%
  split(list(.$Species)) %>%
  map(.f = function(x) {
    x %>%
      mutate_at(vars(Metric, Name),
                list(~ fct_reorder(., relImp))) %>%
      ggplot(aes(x = Name,
                 y = relImp)) +
      geom_col(fill = 'gray40') +
      coord_flip() +
      labs(x = 'Metric',
           y = 'Relative Importance')
    })

# add species name to each plot
for(i in 1:length(rel_imp_list)) {
  rel_imp_list[[i]] = rel_imp_list[[i]] +
    labs(title = names(qrf_mods)[[i]])
}

all_rel_imp_p = ggpubr::ggarrange(plotlist = rel_imp_list,
                  nrow = 1,
                  ncol = 2)
all_rel_imp_p
```

Partial dependence plots show the marginal effect of each covariate by displaying the predicted capacity as that covariate changes, assuming all the other covariates remain fixed at their average values. The partial dependence plots are shown for Chinook (Figure \@ref(fig:pdp-chnk)) and steelhead (Figure \@ref(fig:pdp-sthd)).

```{r pdp-chnk, fig.cap = "Partial dependence plots for Chinook QRF model."}
plot_partial_dependence(qrf_mods[['Chinook']],
                        qrf_mod_df %>%
                          filter(Species == 'Chinook'),
                        data_dict = hab_dict,
                        log_offset = dens_offset,
                        scales = 'free') +
  labs(title = 'Chinook')
```

```{r pdp-sthd, fig.cap = "Partial dependence plots for steelhead QRF model."}
plot_partial_dependence(qrf_mods[['Steelhead']],
                        qrf_mod_df %>%
                          filter(Species == 'Steelhead'),
                        data_dict = hab_dict,
                        log_offset = dens_offset,
                        scales = 'free') +
  labs(title = 'Steelhead')
```

From this QRF model, we made capacity predictions at every CHaMP site, after averaging the habitat metrics across years for sites visited more than once. We extrapolated those predictions of capacity at CHaMP sites to every master sample points using various globally available attributes assigned to every master sample point (including each CHaMP sites).

<!-- We then tied each CHaMP site to a 200 m reach on a stream network with various attributes, and used those attributes to extrapolate capacity to every 200 m reach on that network.  -->

# Methods

## Watershed Maps

We created maps depicting the entire watershed (Lemhi, Pahsimeroi and Upper Salmon) showing QRF predicted summer juvenile capacity in units of fish / m$^2$. 

## Geomorphic Reaches

<!-- We took our QRF extrapolation estimates at each 200 m reach, and determined which reaches fell into each geomorphic reach within each watershed. Then we examined the distribution of capacity estimates within each reach, and the average capacity for each reach. -->

We took our QRF extrapolation estimates at each master sample point, and determined which points fell into each geomorphic reach within each watershed. Then we examined the distribution of capacity estimates within each reach, and the average capacity for each reach.


## Capacity at MRA sites

We used the QRF model to predict capacity at MRA sites that were sampled with DASH in 2018. We used the predicted `r pred_quant * 100`th quantile as a proxy for carrying capacity. 

# Results

## Watershed Maps

```{r wtsd_maps, eval = F}
# Chinook
chnk_maps = cap_pts %>%
  filter(!is.na(chnk_use)) %>%
  split(list(.$HUC8NmNRCS)) %>%
  map(.f = function(x) {

    # wtsd_bb = st_bbox(x) %>%
    #   st_as_sfc()
    wtsd_bndry = x %>%
      st_union() %>%
      st_convex_hull()
    
    strm_lines = QRFcapacity::get_flowlines(stream_order = 2,
                                            wtsd_polygon = wtsd_bndry) %>%
      st_transform(st_crs(x)) %>%
      filter(grepl(unique(x$HUC_8), REACHCODE))
    
    x %>%
      ggplot() +
      geom_sf(data = strm_lines,
              color = 'blue') +
      geom_sf(aes(color = chnk_per_m2)) +
      scale_color_viridis_c(direction = -1,
                       name = expression('Chinook per'~m^2)) +
      theme(axis.text.x = element_text(angle = -45, vjust = 0),
            axis.title.x = element_blank(),
            axis.title.y = element_blank(),
            legend.position = "bottom")
  })
for(nm in names(chnk_maps)) {
  chnk_maps[[nm]] = chnk_maps[[nm]] +
    labs(title = nm)
}

# steelhead
sthd_maps = cap_pts %>%
  filter(!is.na(sthd_use)) %>%
  filter(! HUC10NmNRC %in% c('Valley Creek', 
                                  'Yankee Fork')) %>%
  split(list(.$HUC8NmNRCS)) %>%
  map(.f = function(x) {

    # wtsd_bb = st_bbox(x) %>%
    #   st_as_sfc()
    wtsd_bndry = x %>%
      st_union() %>%
      st_convex_hull()
    
    strm_lines = QRFcapacity::get_flowlines(stream_order = 2,
                                            wtsd_polygon = wtsd_bndry) %>%
      st_transform(st_crs(x)) %>%
      filter(grepl(unique(x$HUC_8), REACHCODE))
    
    x %>%
      ggplot() +
      geom_sf(data = strm_lines,
              color = 'blue') +
      geom_sf(aes(color = sthd_per_m2)) +
      scale_color_viridis_c(direction = -1,
                       name = expression('Steelhead per'~m^2)) +
      theme(axis.text.x = element_text(angle = -45, vjust = 0),
            axis.title.x = element_blank(),
            axis.title.y = element_blank(),
            legend.position = "bottom")
  })
for(nm in names(sthd_maps)) {
  sthd_maps[[nm]] = sthd_maps[[nm]] +
    labs(title = nm)
}

```

```{r wtsd_maps_rch}
chnk_maps = rch_cap %>%
  split(list(.$HUC8_code)) %>%
  map(.f = function(x) {
    wtsd_bndry = x %>%
      filter(sthd | chnk) %>%
      st_union() %>%
      st_convex_hull()
    
    strm_lines = QRFcapacity::get_flowlines(stream_order = 2,
                                            wtsd_polygon = wtsd_bndry) %>%
      st_transform(st_crs(x)) %>%
      filter(grepl(unique(x$HUC8_code), REACHCODE))
    
    x %>%
      filter(chnk) %>%
      ggplot() +
      geom_sf(data = strm_lines,
              color = "lightblue") +
      geom_sf(aes(fill = chnk_per_m2,
                  color = chnk_per_m2),
              lwd = 1) +
      scale_color_viridis_c(direction = -1,
                       name = expression('Chinook per'~m^2)) +
      scale_fill_viridis_c(direction = -1,
                       name = expression('Chinook per'~m^2)) +
      theme(axis.text.x = element_text(angle = -45, vjust = 0),
            axis.title.x = element_blank(),
            axis.title.y = element_blank(),
            legend.position = "bottom")
  })
names(chnk_maps) = c('Upper Salmon',
                     'Pahsimeroi',
                     'Lemhi')
for(nm in names(chnk_maps)) {
  chnk_maps[[nm]] = chnk_maps[[nm]] +
    labs(title = nm)
}

sthd_maps = rch_cap %>%
  split(list(.$HUC8_code)) %>%
  map(.f = function(x) {
    wtsd_bndry = x %>%
      filter(sthd | chnk) %>%
      st_union() %>%
      st_convex_hull()
    
    strm_lines = QRFcapacity::get_flowlines(stream_order = 2,
                                            wtsd_polygon = wtsd_bndry) %>%
      st_transform(st_crs(x)) %>%
      filter(grepl(unique(x$HUC8_code), REACHCODE))
    
    x %>%
      filter(sthd) %>%
      ggplot() +
      geom_sf(data = strm_lines,
              color = "lightblue") +
      geom_sf(aes(fill = sthd_per_m2,
                  color = sthd_per_m2),
              lwd = 1) +
      scale_color_viridis_c(direction = -1,
                       name = expression('Steelhead per'~m^2)) +
      scale_fill_viridis_c(direction = -1,
                       name = expression('Steelhead per'~m^2)) +
      theme(axis.text.x = element_text(angle = -45, vjust = 0),
            axis.title.x = element_blank(),
            axis.title.y = element_blank(),
            legend.position = "bottom")
  })
names(sthd_maps) = c('Upper Salmon',
                     'Pahsimeroi',
                     'Lemhi')
for(nm in names(sthd_maps)) {
  sthd_maps[[nm]] = sthd_maps[[nm]] +
    labs(title = nm)
}
```

```{r chnk_map_lem}
chnk_maps[["Lemhi"]]
```

```{r chnk_map_pah}
chnk_maps[["Pahsimeroi"]]
```

```{r chnk_map_ups}
chnk_maps[["Upper Salmon"]]
```

```{r sthd_map_lem}
sthd_maps[["Lemhi"]]
```

```{r sthd_map_pah}
sthd_maps[["Pahsimeroi"]]
```

```{r sthd_map_ups}
sthd_maps[["Upper Salmon"]]
```


## Geomorphic Reaches

The distribution of capacity predictions within each geomorphic reach is shown in Figures \@ref(fig:chnk-violin-p) and \@ref(fig:sthd-violin-p). Figures \@ref(fig:lem-map), \@ref(fig:pah-map) and \@ref(fig:ups-map) are maps depicting the average capacity within each geomorphic reach.

```{r}
geo_rch_list = list("Lemhi" = lem_geo_rch %>%
                      mutate(Watershed = 'Lemhi'),
                    "Pahsimeroi" = pah_geo_rch %>%
                      mutate(Watershed = 'Pahsimeroi'),
                    "Upper Salmon" = ups_geo_rch %>%
                      mutate(Watershed = 'Upper Salmon'))

# uses extrapolation estimates from Morgan's 200 m reaches
gr_cap = geo_rch_list %>%
  map(.f = function(x) {
    x %>%
      st_join(rch_cap %>%
                filter(sthd) %>%
                select(UniqueID,
                       GNIS_Name,
                       model,
                       matches('sthd_per'),
                       matches('sthd_tot')) %>%
                full_join(rch_cap %>%
                            filter(chnk) %>%
                            st_drop_geometry() %>%
                            select(UniqueID,
                                   GNIS_Name,
                                   model,
                                   matches('chnk_per'),
                                   matches('chnk_tot')))) %>%
      # filter((Watershed == 'Lemhi' & GNIS_Name == 'Lemhi River') |
      #          (Watershed == 'Pahsimeroi' & GNIS_Name == 'Pahsimeroi River') |
      #          (Watershed == 'Upper Salmon' & GNIS_Name == 'Salmon River')) %>%
      mutate(rch_num = str_extract(GeoReach, '[:digit:]+'),
             rch_num = as.numeric(rch_num),
             GeoReach = str_replace(GeoReach, '_', '-')) %>%
      mutate(GeoReach = factor(GeoReach,
                           levels = paste0("GR-", min(rch_num):max(rch_num))))
  })

# # uses extrapolation from master sample points
# gr_cap = geo_rch_list %>%
#   map(.f = function(x) {
#     x %>%
#       st_join(cap_pts %>%
#                 filter(!is.na(sthd_use)) %>%
#                 select(Site, 
#                        matches('sthd_per')) %>%
#                 full_join(cap_pts %>%
#                             filter(!is.na(chnk_use)) %>%
#                             st_drop_geometry() %>%
#                             select(Site,
#                                    matches('chnk_per')))) %>%
#       mutate(rch_num = str_extract(GeoReach, '[:digit:]+'),
#              rch_num = as.numeric(rch_num),
#              GeoReach = str_replace(GeoReach, '_', '-')) %>%
#       mutate(GeoReach = factor(GeoReach,
#                                levels = paste0("GR-", min(rch_num):max(rch_num))))
#   })

# put into data.frame
gr_cap_df = gr_cap %>%
  map_df(.id = NULL,
         .f = function(x) {
           x %>%
             st_drop_geometry() %>%
             as_tibble()
         }) %>%
  mutate(GeoReach = factor(GeoReach,
                           levels = paste0("GR-", min(rch_num):max(rch_num))))

```

```{r chnk-violin-p, fig.cap = "Violin plots showing the distribution of Chinook capacity estimates for master sample points within each geomorphic reach in each watershed."}
gr_cap_df %>%
  ggplot(aes(x = GeoReach,
             y = chnk_per_m)) +
  # geom_boxplot(fill = 'lightblue') +
  geom_violin(fill = 'lightblue',
              scale = 'width',
              draw_quantiles = c(0.25, 0.5, 0.75)) +
  facet_wrap(~ Watershed,
             scales = 'free_x',
             nrow = 1) +
  labs(x = 'Geomorphic Reach',
       y = 'Chinook capacity (per m)') +
  theme(axis.text.x = element_text(angle = -45, vjust = 0))

```

```{r sthd-violin-p, fig.cap = "Violin plots showing the distribution of steelhead capacity estimates for master sample points within each geomorphic reach in each watershed."}
gr_cap_df %>%
  ggplot(aes(x = GeoReach,
             y = sthd_per_m)) +
  # geom_boxplot(fill = 'lightblue') +
  geom_violin(fill = 'lightblue',
              scale = 'width',
              draw_quantiles = c(0.25, 0.5, 0.75)) +
  facet_wrap(~ Watershed,
             scales = 'free_x',
             nrow = 1) +
  labs(x = 'Geomorphic Reach',
       y = 'Steelhead capacity (per m)') +
  theme(axis.text.x = element_text(angle = -45, vjust = 0))

```


```{r lem-map, fig.cap = "Geomorphic reaches in the Lemhi colored by average capacity (fish per m^2)."}
lem_chnk_map = gr_cap$Lemhi %>%
  group_by(GeoReach) %>%
  summarise_at(vars(matches('per_m')),
               list(mean),
               na.rm = T) %>%
  ungroup() %>%
  ggplot() +
  geom_sf(aes(fill = chnk_per_m2)) +
  scale_fill_viridis_c(direction = -1,
                       name = expression('Capacity per'~m^2)) +
  geom_sf_label(aes(label = str_remove(GeoReach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  labs(title = 'Chinook')

lem_sthd_map = gr_cap$Lemhi %>%
  group_by(GeoReach) %>%
  summarise_at(vars(matches('per_m')),
               list(mean),
               na.rm = T) %>%
  ungroup() %>%
  ggplot() +
  geom_sf(aes(fill = sthd_per_m2)) +
  scale_fill_viridis_c(direction = -1,
                       name = expression('Capacity per'~m^2)) +
  geom_sf_label(aes(label = str_remove(GeoReach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  labs(title = 'Steelhead')

ggarrange(plotlist = list(lem_chnk_map,
                          lem_sthd_map),
          labels = 'AUTO',
          nrow = 1,
          common.legend = T,
          legend = 'bottom')

```

```{r pah-map, fig.cap = "Geomorphic reaches in the Pahsimeroi colored by average capacity (fish per m^2)."}
pah_chnk_map = gr_cap$Pahsimeroi %>%
  group_by(GeoReach) %>%
  summarise_at(vars(matches('per_m')),
               list(mean),
               na.rm = T) %>%
  ungroup() %>%
  ggplot() +
  geom_sf(aes(fill = chnk_per_m2)) +
  scale_fill_viridis_c(direction = -1,
                       name = expression('Capacity per'~m^2)) +
  geom_sf_label(aes(label = str_remove(GeoReach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  labs(title = 'Chinook')

pah_sthd_map = gr_cap$Pahsimeroi %>%
  group_by(GeoReach) %>%
  summarise_at(vars(matches('per_m')),
               list(mean),
               na.rm = T) %>%
  ungroup() %>%
  ggplot() +
  geom_sf(aes(fill = sthd_per_m2)) +
  scale_fill_viridis_c(direction = -1,
                       name = expression('Capacity per'~m^2)) +
  geom_sf_label(aes(label = str_remove(GeoReach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  labs(title = 'Steelhead')

ggarrange(plotlist = list(pah_chnk_map,
                          pah_sthd_map),
          labels = 'AUTO',
          nrow = 1,
          legend = 'bottom',
          common.legend = T)

```

```{r ups-map, fig.cap = "Geomorphic reaches in the upper Salmon colored by average capacity (fish per m^2)."}
ups_chnk_map = gr_cap$`Upper Salmon` %>%
  group_by(GeoReach) %>%
  summarise_at(vars(matches('per_m')),
               list(mean),
               na.rm = T) %>%
  ungroup() %>%
  ggplot() +
  geom_sf(aes(fill = chnk_per_m2)) +
  scale_fill_viridis_c(direction = -1,
                       name = expression('Capacity per'~m^2)) +
  geom_sf_label(aes(label = str_remove(GeoReach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  labs(title = 'Chinook')

ups_sthd_map = gr_cap$`Upper Salmon` %>%
  group_by(GeoReach) %>%
  summarise_at(vars(matches('per_m')),
               list(mean),
               na.rm = T) %>%
  ungroup() %>%
  ggplot() +
  geom_sf(aes(fill = sthd_per_m2)) +
  scale_fill_viridis_c(direction = -1,
                       name = expression('Capacity per'~m^2)) +
  geom_sf_label(aes(label = str_remove(GeoReach, "^GR_")),
                size = 2,
                nudge_x = 3000,
                nudge_y = 500) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom") +
  labs(title = 'Steelhead')

ggarrange(plotlist = list(ups_chnk_map,
                          ups_sthd_map),
          labels = 'AUTO',
          nrow = 1,
          common.legend = T,
          legend = 'bottom')

```

## Capacity at MRA sites

```{r mra-maps}
# using fish / m^2
map_list = pred_sf %>%
  split(list(.$Site)) %>%
  map(.f = function(x) {
    x %>%
      ggplot() +
      geom_sf(aes(color = chnk_per_m2,
                  fill = chnk_per_m2)) +
      scale_color_viridis_c(direction = -1,
                            name = bquote("Chinook Parr (per " *m^2 *")")) +
      scale_fill_viridis_c(direction = -1,
                           name = bquote("Chinook Parr (per " *m^2 *")")) +
      theme(axis.text = element_blank(),
            legend.position = 'bottom') +
      labs(title = unique(x$Site))
  })

# using fish / m
map_list_per_m = pred_sf %>%
  split(list(.$Site)) %>%
  map(.f = function(x) {
    x %>%
      ggplot() +
      geom_sf(aes(color = chnk_per_m,
                  fill = chnk_per_m)) +
      scale_color_viridis_c(direction = -1,
                            name = "Chinook Parr (per m)") +
      scale_fill_viridis_c(direction = -1,
                           name = "Chinook Parr (per m)") +
      theme(axis.text = element_blank(),
            legend.position = 'bottom') +
      labs(title = unique(x$Site))
  })

```

```{r save-maps, eval = F}
# save maps as pdfs
pdf("../output/figures/Chnk_Parr_Maps.pdf",
       width = 5,
       height = 8)
for(i in seq_along(map_list)) {
  print(map_list[[i]])
}
dev.off()

pdf("../output/figures/Chnk_Parr_Maps_per_m.pdf",
       width = 5,
       height = 8)
for(i in seq_along(map_list)) {
  print(map_list_per_m[[i]])
}
dev.off()


# ggarrange(plotlist = map_list,
#           nrow = 2,
#           ncol = 2,
#           common.legend = T,
#           legend = 'bottom')

# ggarrange(plotlist = map_list_per_m,
#           nrow = 2,
#           ncol = 2,
#           common.legend = T,
#           legend = 'bottom')


```

```{r qrf-upl-map}
map_list_per_m[["UpperLemhi_2018"]]
```

```{r qrf-pah-map}
map_list_per_m[["Pahsimeroi_2018"]]
```

```{r qrf-lwl-map}
map_list_per_m[["LowerLemhi_2018"]]
```

```{r qrf-usl-map}
map_list_per_m[["UpperSalmon_2018"]]
```

Here are some options to help understand what factors are driving high or low capacity within each MRA reach.

```{r cap-eda-figs}
# better labels for facetting
fnames = c(
  `Avg. August Temperature` = "Avg. August Temperature",
  `Channel Unit Frequency` = "Channel Unit Frequency",
  `Fish Cover: Some Cover` = "Fish Cover: Some Cover",
  `Large Wood Volume: Wetted` = "Large Wood\nVolume: Wetted",
  `Discharge` = "Discharge",
  `Sinuosity Via Centerline` = "Sinuosity via Centerline",
  `Slow Water Percent` = "Slow Water Percent",
  `Substrate Est: Coarse and Fine Gravel` = "Substrate Est:\nCoarse and Fine Gravel",
  `Percent Undercut by Length` = "Percent Undercut by Length",
  `Wetted Channel Braidedness` = "Wetted Channel\nBraidedness",
  `Wetted Side Channel Percent By Area` = "Wetted Side Channel\nPercent By Area",
  `Wetted Width Integrated` = "Wetted Width Integrated"
)


bar_plot_list = pred_df %>%
  split(list(.$Site)) %>%
  map(.f = function(x) {
    x %>%
      gather(Metric, value, -c(Site:Area_Wet), -starts_with("chnk")) %>%
      mutate_at(vars(Hab_Rch),
                list(as.factor)) %>%
      mutate(Hab_Rch = fct_reorder(Hab_Rch,
                                    chnk_per_m2)) %>%
      left_join(rel_imp_df %>%
                  filter(Species == 'Chinook')) %>%
      mutate_at(vars(Metric, Name),
                list(~ fct_reorder(., desc(relImp)))) %>%
      ggplot(aes(x = Hab_Rch,
                 y = value,
                 fill = chnk_per_m2)) +
      geom_col() +
      scale_fill_viridis_c(direction = -1) +
      facet_wrap(~ Name,
                 scales = 'free_y',
                 labeller = labeller(Name = as_labeller(fnames))) +
      theme(legend.position = "bottom",
            axis.text.x = element_blank()) +
      labs(x = 'Habitat Reach',
           y = 'Metric Value',
           fill = expression('Chinook per'~m^2))
  })

xy_plot_list = pred_df %>%
  split(list(.$Site)) %>%
  map(.f = function(x) {
    x %>%
      gather(Metric, value, -c(Site:Area_Wet), -starts_with("chnk")) %>%
  mutate_at(vars(Hab_Rch),
            list(as.factor)) %>%
  mutate(Hab_Rch = fct_reorder(Hab_Rch,
                                chnk_per_m2)) %>%
  left_join(rel_imp_df %>%
              filter(Species == 'Chinook')) %>%
  mutate_at(vars(Metric, Name),
            list(~ fct_reorder(., desc(relImp)))) %>%
  ggplot(aes(x = value,
             y = chnk_per_m2)) +
  geom_smooth() +
  geom_point() +
  facet_wrap(~ Name,
             scales = 'free',
             labeller = labeller(Name = as_labeller(fnames))) +
  labs(x = 'Metric Value',
       y = expression('Chinook per'~m^2))
  })

for(nm in names(bar_plot_list)) {
  bar_plot_list[[nm]] = bar_plot_list[[nm]] +
    labs(title = nm)
}


xy_df = pred_df %>%
  gather(Metric, value, -c(Site:Area_Wet), -starts_with("chnk")) %>%
  mutate(Site = str_remove(Site, "_2018$"),
         Site = recode(Site,
                       "LowerLemhi" = "Lower Lemhi",
                       "UpperLemhi" = "Upper Lemhi",
                       "UpperSalmon" = "Upper Salmon")) %>%
  mutate_at(vars(Hab_Rch),
            list(as.factor)) %>%
  mutate(Hab_Rch = fct_reorder(Hab_Rch,
                                chnk_per_m2)) %>%
  left_join(rel_imp_df %>%
              filter(Species == 'Chinook')) %>%
  mutate_at(vars(Metric, Name),
            list(~ fct_reorder(., desc(relImp))))

xy_plot_all = xy_df %>%
  ggplot(aes(x = value,
             y = chnk_per_m2)) +
  geom_smooth(data = xy_df %>%
                filter(!(Metric == "WetBraid" & value <= 1))) +
  geom_point(aes(color = Site)) +
  scale_color_brewer(palette = 'Set1',
                     guide = guide_legend(nrow = 1)) +
  facet_wrap(~ Name,
             scales = 'free_x',
             labeller = labeller(Name = as_labeller(fnames)),
             ncol = 2) +
  theme(legend.position = 'bottom',
        strip.text = element_text(size = 8)) +
  coord_cartesian(ylim = c(0, 1)) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 3)) +
  labs(x = 'Habitat Metric Value',
       y = expression('Capacity (Chinook per'~m^2~")"))

ggsave(filename = paste0(knitr::opts_chunk$get("fig.path"), "cap_xy_fig.png"),
       xy_plot_all,
       width = 5.5,
       height = 11)

box_plot_all = pred_df %>%
  gather(Metric, value, -c(Site:Area_Wet), -starts_with("chnk")) %>%
  mutate_at(vars(Hab_Rch),
            list(as.factor)) %>%
  mutate(Hab_Rch = fct_reorder(Hab_Rch,
                                chnk_per_m2)) %>%
  left_join(rel_imp_df %>%
              filter(Species == 'Chinook')) %>%
  mutate_at(vars(Metric, Name),
            list(~ fct_reorder(., desc(relImp)))) %>%
  mutate(Site = str_remove(Site, "_2018$")) %>%
  group_by(Site) %>%
  mutate(avg_cap = mean(chnk_per_m2, na.rm = T)) %>%
  # mutate(avg_cap = mean(chnk_per_m, na.rm = T)) %>%
  ungroup() %>%
  mutate_at(vars(Site),
            list(~ fct_reorder(., avg_cap))) %>%
  ggplot(aes(x = Site,
             y = value)) +
  geom_boxplot(aes(fill = avg_cap)) +
  scale_fill_viridis_c(direction = -1,
                       name = expression('Avg. Chinook per'~m^2)) +
  # scale_fill_brewer(palette = 'Set1') +
  facet_wrap(~ Name,
             scales = 'free_y',
             labeller = labeller(Name = as_labeller(fnames))) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1),
        legend.position = "bottom") +
  labs(x = "Site",
       y = "Metric Value")
```

```{r cap-xy-plot, fig.cap = "Scatterplot of covariates and Chinook parr capacity, colored by MRA site. The facet order of covariates corresponds to their relative importance."}
xy_plot_all
```

```{r cap-box-plot, fig.cap = "Boxplots showing distribution of covariates in each MRA site, colored by their average Chinook parr capacity. The facet order of covariates corresponds to their relative importance."}
box_plot_all
```


The following are bar plots, split by MRA site. Within each MRA site, the habitat reaches are ordered lowest capacity to highest, and the bars are also colored that way. The height of each bar shows the value of that habitat covariate.

```{r}
bar_plot_list[[1]]
bar_plot_list[[2]]
bar_plot_list[[3]]
bar_plot_list[[4]]
```

```{r pdp-mra-points, eval =T} 
# new partial dependent plots

rf_mod = qrf_mods[['Chinook']]
data = qrf_mod_df %>%
  filter(Species == 'Chinook')
data_dict = hab_dict
log_offset = dens_offset
type = 'quantile'
pred_quantile = 0.9
n_pts = 200
log_transform = T
plot_covars = NULL

# relative importance of covariates
rel_imp = as_tibble(rf_mod$importance,
                    rownames = 'Metric') %>%
  mutate(relImp = IncNodePurity / max(IncNodePurity)) %>%
  mutate_at(vars(Metric),
            list(~ fct_reorder(., relImp))) %>%
  arrange(desc(Metric))

# names of covariates
covars = rel_imp$Metric
if(is.null(plot_covars)) plot_covars = covars

# get means and ranges of all
covar_range = data %>%
  select(one_of(as.character(plot_covars))) %>%
  gather(Metric, value) %>%
  group_by(Metric) %>%
  summarise_at(vars(value),
               list(mean = mean, 
                    median = median, 
                    min = min, 
                    max = max),
               na.rm = T) %>%
  ungroup()

# create data.frame with sequence of values across each covariate, keeping other covariates at their average value
pdp_df = covar_range %>%
  split(.$Metric) %>%
  map_df(.id = 'Metric',
         .f = function(x) {
           
           if(class(pull(data, x$Metric)) %in% c('integer', 'numeric')) {
             df = crossing(value = seq(x$min,
                                       x$max,
                                       length.out = n_pts),
                           covar_range %>%
                             filter(Metric != x$Metric) %>%
                             select(Metric, median) %>%
                             spread(Metric, median)) %>%
               mutate(met = value)
             
             names(df)[match('met', names(df))] = x$Metric
             
           } 
           if(class(pull(data, x$Metric)) %in% c('factor')) {
             df = crossing(value = data %>%
                             select(x$Metric) %>%
                             levels,
                           covar_range %>%
                             filter(Metric != x$Metric) %>%
                             select(Metric, median) %>%
                             spread(Metric, median)) %>%
               mutate(met = value)
             
             names(df)[match('met', names(df))] = x$Metric
           }
           
           return(df)
         }) %>%
  mutate(Metric = factor(Metric,
                         levels = levels(covars)))

# make predictions
if(type == 'quantile') {
  pdp_df = pdp_df %>%
    mutate(pred = predict(rf_mod,
                          newdata = .,
                          what = pred_quantile))
}
if(type == 'mean') {
  pdp_df = pdp_df %>%
    mutate(pred = predict(rf_mod,
                          newdata = .,
                          what = mean))
}

# transform predictions back from log-scale if necessary
if(log_transform) {
  pdp_df = pdp_df %>%
    mutate_at(vars(pred),
              list(~ exp(.) - log_offset))
}

# get covariate labels
pdp_df = pdp_df %>%
  left_join(data_dict %>%
              select(Metric = ShortName, covar_label = Name)) %>%
  # put covariates in order by relative importance
  left_join(rel_imp %>%
              select(Metric, relImp)) %>%
  mutate_at(vars(Metric, covar_label),
            list(~ fct_reorder(., relImp))) %>%
  mutate_at(vars(Metric, covar_label),
            list(fct_rev))


# create data.frame for rug ticks
rug_df = pred_df %>%
  gather(Metric, value, -c(Site:Area_Wet), -starts_with("chnk")) %>%
  left_join(rel_imp %>%
              left_join(data_dict %>%
                          select(Metric = ShortName, 
                                 covar_label = Name))) %>%
  mutate_at(vars(Metric, covar_label),
            list(~ fct_reorder(., relImp))) %>%
  mutate_at(vars(Metric, covar_label),
            list(fct_rev)) %>%
  select(Metric, covar_label, Site, value) %>%
  mutate_at(vars(value),
            list(round),
            digits = 1) %>%
  left_join(pdp_df %>%
              select(Metric, value, pred) %>%
              mutate_at(vars(value),
                        list(round),
                        digits = 1))

# my_p = pdp_df %>%
#   filter(Metric %in% plot_covars) %>%
#   ggplot(aes(x = value,
#              y = pred)) +
#   geom_smooth(method = 'loess',
#               se = F,
#               # span = 0.7,
#               color = 'black') +
#   # geom_line(color = 'gray',
#   #           lwd = 1,
#   #           linetype = 2) +
#   geom_point(data = rug_df %>%
#                filter(Metric %in% plot_covars) %>%
#                distinct(), 
#              aes(color = Site)) +
#   scale_color_brewer(palette = 'Set1') +
#   theme_bw() +
#   theme(legend.position = 'bottom') +
#   labs(y = 'Prediction (per m)',
#        x = 'Covariate Value',
#        color = 'MRA Site') +
#   facet_wrap(~ covar_label,
#              scales = "free")
# 
# my_p

pdp_list = rug_df %>%
  split(list(.$Site)) %>%
  map(.f = function(x) {
    pdp_df %>%
  filter(Metric %in% plot_covars) %>%
  ggplot(aes(x = value,
             y = pred)) +
  geom_smooth(method = 'loess',
              se = F,
              # span = 0.7,
              color = 'black') +
  # geom_line(color = 'gray',
  #           lwd = 1,
  #           linetype = 2) +
  geom_point(data = x %>%
               filter(Metric %in% plot_covars) %>%
               distinct(), 
             color = 'red') +
  theme_bw() +
  theme(legend.position = 'bottom') +
  labs(y = 'Prediction (per m)',
       x = 'Covariate Value',
       title = unique(x$Site)) +
  facet_wrap(~ covar_label,
             scales = "free_x")
  })

```

```{r pdp-mra-figs, fig.cap = "Partial dependence plots of the Chinook parr QRF model, showing the measured values of the covariates for each habitat reach within a particular MRA site. Note that the y-axis shows predictions of capacity on a linear density scale (fish / m)."}
pdp_list[[1]]
pdp_list[[2]]
pdp_list[[3]]
pdp_list[[4]]
```

